<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Molecular Workbench V4 (Final)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;600&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #334155; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        
        /* Custom Selection */
        ::selection { background: #bae6fd; color: #0369a1; }

        /* Protein Residue Box - Show Number Always */
        .residue-box {
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
            width: 20px; margin: 1px; cursor: pointer; user-select: none;
        }
        .residue-char {
            font-size: 1rem; font-weight: bold; width: 100%; text-align: center;
            border-radius: 4px; transition: all 0.1s; color: #475569;
        }
        .residue-box:hover .residue-char { background-color: #e2e8f0; color: #0f172a; transform: scale(1.2); }
        .residue-char.masked {
            background-color: #334155; color: #f59e0b; text-decoration: line-through; opacity: 0.9;
        }
        .residue-num {
            font-size: 0.5rem; color: #94a3b8; margin-top: 1px; font-family: sans-serif;
        }

        /* Rare Codon Highlights */
        .codon-rare {
            background-color: #fee2e2; color: #dc2626; font-weight: bold; 
            border-bottom: 2px dotted #ef4444; cursor: help;
        }
        .codon-normal { color: #64748b; }
        
        /* Preview Box */
        .preview-box {
            min-height: 24px; font-size: 0.85rem; padding: 4px 8px; 
            background: #f1f5f9; border-radius: 4px; color: #0f172a;
            border-left: 3px solid #3b82f6; font-family: 'JetBrains Mono', monospace;
        }
    </style>
</head>
<body class="p-4 md:p-8 max-w-7xl mx-auto">

    <header class="flex flex-col md:flex-row justify-between items-center mb-6 border-b border-slate-200 pb-4 gap-4">
        <div>
            <h1 class="text-2xl font-bold text-slate-800 flex items-center gap-2">
                üß¨ Molecular Workbench <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full">v4.0</span>
            </h1>
            <p class="text-slate-500 text-sm mt-1">Accurate Primer Tm ‚Ä¢ Precise Masking ‚Ä¢ Kazusa E. coli</p>
        </div>
        
        <div class="flex bg-slate-100 p-1 rounded-lg">
            <button onclick="switchTab('primer')" id="tab-primer" class="px-4 py-2 text-sm font-medium rounded-md shadow bg-white text-blue-600">Primer Pairs</button>
            <button onclick="switchTab('protein')" id="tab-protein" class="px-4 py-2 text-sm font-medium rounded-md text-slate-500 hover:text-slate-700">Protein Masking</button>
            <button onclick="switchTab('codon')" id="tab-codon" class="px-4 py-2 text-sm font-medium rounded-md text-slate-500 hover:text-slate-700">Rare Codon</button>
        </div>
    </header>

    <div id="content-primer" class="tool-content">
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold text-slate-700">‚ö° Primer Pair Designer</h2>
                <div class="text-xs text-slate-400 bg-slate-50 px-2 py-1 rounded">Ta = Min(Tm) - 5¬∞C</div>
            </div>

            <div class="grid md:grid-cols-2 gap-6 mb-6">
                <div class="flex flex-col gap-2">
                    <label class="font-bold text-sm text-slate-700">Forward Primer (5'‚ûù3')</label>
                    <textarea id="fwdInput" class="w-full h-24 p-3 font-mono text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-400 outline-none"
                        placeholder="Paste FWD Sequence..." onmouseup="updatePreview('fwd')" onkeyup="updatePreview('fwd')"></textarea>
                    <div class="text-xs text-slate-500 mt-1">Selected Annealing Part:</div>
                    <div id="fwdPreview" class="preview-box text-slate-400 italic">None selected</div>
                </div>

                <div class="flex flex-col gap-2">
                    <label class="font-bold text-sm text-slate-700">Reverse Primer (5'‚ûù3')</label>
                    <textarea id="revInput" class="w-full h-24 p-3 font-mono text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-400 outline-none"
                        placeholder="Paste REV Sequence..." onmouseup="updatePreview('rev')" onkeyup="updatePreview('rev')"></textarea>
                    <div class="text-xs text-slate-500 mt-1">Selected Annealing Part:</div>
                    <div id="revPreview" class="preview-box text-slate-400 italic">None selected</div>
                </div>
            </div>

            <div class="flex justify-end mb-6">
                <button onclick="addPrimerPair()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium shadow-sm transition flex items-center gap-2">
                    <span>+ Add Pair & Analyze</span>
                </button>
            </div>

            <div class="overflow-x-auto border border-slate-200 rounded-lg">
                <table class="w-full text-sm text-left">
                    <thead class="bg-slate-50 text-slate-600 font-semibold border-b border-slate-200">
                        <tr>
                            <th class="px-4 py-3">#</th>
                            <th class="px-4 py-3">Pair Details</th>
                            <th class="px-4 py-3 w-40">Physics (Hairpin/Dimer)</th>
                            <th class="px-4 py-3 w-32 text-center bg-blue-50">PCR Setup</th>
                            <th class="px-4 py-3 w-10"></th>
                        </tr>
                    </thead>
                    <tbody id="primerTableBody" class="divide-y divide-slate-100 bg-white"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="content-protein" class="tool-content hidden">
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
            <h2 class="text-lg font-semibold mb-4 text-purple-700">üé≠ Protein Masking (Explicit Numbering)</h2>
            <div class="flex gap-3 mb-6">
                <input id="masterProteinSeq" type="text" class="flex-1 p-3 border border-slate-200 rounded-lg font-mono text-sm outline-none focus:border-purple-400" placeholder="Paste Sequence Here...">
                <button onclick="createWorkspace()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white font-medium rounded-lg transition whitespace-nowrap">+ Add Workspace</button>
            </div>
            <div id="workspaceContainer" class="space-y-6"></div>
        </div>
    </div>

    <div id="content-codon" class="tool-content hidden">
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
            <h2 class="text-lg font-semibold mb-2 text-red-600">ü¶† E. coli Rare Codon Analysis</h2>
            <p class="text-xs text-slate-500 mb-4">Database: <strong>Kazusa (E. coli K-12 MG1655)</strong>. Threshold: Freq < 10/1000.</p>
            
            <textarea id="codonInput" class="w-full p-3 border border-slate-300 rounded-lg font-mono text-sm outline-none focus:ring-2 focus:ring-red-200 mb-4" rows="3" placeholder="Paste DNA Coding Sequence (ATG...)" oninput="analyzeCodons()"></textarea>

            <div class="grid md:grid-cols-3 gap-6">
                <div class="md:col-span-2">
                    <div id="codonVisual" class="p-4 bg-slate-50 border border-slate-200 rounded-lg font-mono text-sm break-all leading-loose min-h-[150px]">
                        <span class="text-slate-400">Sequence map will appear here...</span>
                    </div>
                </div>
                <div class="md:col-span-1">
                    <div id="codonReport" class="p-4 bg-white border border-slate-200 rounded-lg h-[300px] overflow-y-auto text-sm shadow-inner">
                        <ul class="text-slate-500 text-xs"><li>Waiting for input...</li></ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- UI ---
        function switchTab(tab) {
            document.querySelectorAll('.tool-content').forEach(el => el.classList.add('hidden'));
            document.getElementById('content-' + tab).classList.remove('hidden');
            document.querySelectorAll('header button').forEach(b => {
                b.className = "px-4 py-2 text-sm font-medium rounded-md text-slate-500 hover:text-slate-700 transition";
            });
            document.getElementById('tab-' + tab).className = "px-4 py-2 text-sm font-medium rounded-md shadow bg-white text-blue-600 transition";
        }

        // --- 1. PRIMER LOGIC (Complete) ---
        let currentPair = { fwd: null, rev: null };

        function updatePreview(type) {
            const el = document.getElementById(type + 'Input');
            const preview = document.getElementById(type + 'Preview');
            
            const start = el.selectionStart;
            const end = el.selectionEnd;
            const raw = el.value;
            const selected = raw.substring(start, end).replace(/[^ATGCatgc]/g, '').toUpperCase();
            
            if (selected.length > 0) {
                preview.innerHTML = `<span class="font-bold text-blue-600">${selected}</span> <span class="text-xs text-slate-500 ml-2">(${selected.length} bp)</span>`;
                preview.classList.remove('text-slate-400', 'italic');
                
                // Temp store
                currentPair[type] = {
                    full: raw.replace(/\s/g, '').toUpperCase(),
                    anneal: selected,
                    tm: calculateTm(selected),
                    gc: calculateGC(raw.replace(/\s/g, '').toUpperCase()),
                    risk: checkRisk(raw.replace(/\s/g, '').toUpperCase()) // Check full seq for risk
                };
            } else {
                preview.innerHTML = "None selected";
                preview.classList.add('text-slate-400', 'italic');
                currentPair[type] = null;
            }
        }

        function calculateTm(seq) {
            if (!seq) return 0;
            const G = (seq.match(/G/g)||[]).length;
            const C = (seq.match(/C/g)||[]).length;
            return (64.9 + 41 * (G + C - 16.4) / seq.length).toFixed(1);
        }

        function calculateGC(seq) {
            if (!seq) return 0;
            const gc = (seq.match(/[GC]/g)||[]).length;
            return ((gc / seq.length) * 100).toFixed(1);
        }

        function checkRisk(seq) {
            // Simple Hairpin & Dimer Check (Heuristic)
            // 1. Dimer (3' End Check - last 5 bases)
            const end3 = seq.slice(-5);
            const revCompEnd3 = end3.split('').reverse().map(b => ({'A':'T','T':'A','G':'C','C':'G'}[b]||b)).join('');
            let dimer = seq.includes(revCompEnd3);
            
            // 2. Hairpin (Palindrome check > 4bp)
            let hairpin = false;
            for(let i=0; i<seq.length-8; i++) {
                let chunk = seq.substr(i, 4);
                let revChunk = chunk.split('').reverse().map(b => ({'A':'T','T':'A','G':'C','C':'G'}[b]||b)).join('');
                if(seq.indexOf(revChunk, i+5) !== -1) hairpin = true;
            }
            return { dimer, hairpin };
        }

        function addPrimerPair() {
            if (!currentPair.fwd || !currentPair.rev) {
                alert("Please highlight the ANNEALING part for both primers.");
                return;
            }

            const tbody = document.getElementById('primerTableBody');
            const count = tbody.rows.length + 1;
            
            // Ta Calculation
            const minTm = Math.min(currentPair.fwd.tm, currentPair.rev.tm);
            const ta = (minTm - 5).toFixed(1);

            const tr = document.createElement('tr');
            tr.className = "hover:bg-slate-50 transition";
            
            // Generate Risk Labels
            const getRiskBadge = (r) => {
                let s = "";
                if(r.hairpin) s+= `<span class="text-[10px] bg-red-100 text-red-600 px-1 rounded border border-red-200">Hairpin</span> `;
                if(r.dimer) s+= `<span class="text-[10px] bg-orange-100 text-orange-600 px-1 rounded border border-orange-200">Self-Dimer</span> `;
                return s || "<span class='text-green-500 text-xs'>‚úì OK</span>";
            };

            tr.innerHTML = `
                <td class="px-4 py-3 text-slate-400 font-mono text-xs align-top">${count}</td>
                <td class="px-4 py-3 align-top">
                    <div class="mb-2">
                        <span class="text-xs font-bold bg-slate-200 px-1 rounded text-slate-600">FWD</span>
                        <span class="font-mono text-xs text-slate-500 break-all">${formatSeq(currentPair.fwd.full, currentPair.fwd.anneal)}</span>
                        <div class="text-[10px] text-slate-400 mt-1">Tm: <b>${currentPair.fwd.tm}¬∞C</b> | GC: ${currentPair.fwd.gc}%</div>
                    </div>
                    <div>
                        <span class="text-xs font-bold bg-slate-200 px-1 rounded text-slate-600">REV</span>
                        <span class="font-mono text-xs text-slate-500 break-all">${formatSeq(currentPair.rev.full, currentPair.rev.anneal)}</span>
                        <div class="text-[10px] text-slate-400 mt-1">Tm: <b>${currentPair.rev.tm}¬∞C</b> | GC: ${currentPair.rev.gc}%</div>
                    </div>
                </td>
                <td class="px-4 py-3 align-top text-xs">
                    <div class="mb-2">Fwd: ${getRiskBadge(currentPair.fwd.risk)}</div>
                    <div>Rev: ${getRiskBadge(currentPair.rev.risk)}</div>
                </td>
                <td class="px-4 py-3 align-middle text-center bg-blue-50 border-x border-slate-100">
                    <div class="text-[10px] text-slate-500 uppercase tracking-wide">Rec. Anneal (Ta)</div>
                    <div class="text-xl font-bold text-blue-700">${ta}¬∞C</div>
                </td>
                <td class="px-4 py-3 align-middle text-center"><button onclick="this.closest('tr').remove()" class="text-slate-300 hover:text-red-500">√ó</button></td>
            `;
            tbody.appendChild(tr);
        }

        function formatSeq(full, anneal) {
            return full.replace(anneal, `<span class="text-black font-bold border-b-2 border-blue-400 bg-blue-50">${anneal}</span>`);
        }

        // --- 2. PROTEIN LOGIC (Numbers) ---
        let wsCount = 0;
        function createWorkspace() {
            const seq = document.getElementById('masterProteinSeq').value.replace(/\s/g, '').toUpperCase();
            if(!seq) return;
            wsCount++;
            const wsId = `ws-${wsCount}`;
            
            let grid = `<div class="flex flex-wrap items-start font-mono mb-2">`;
            seq.split('').forEach((aa, i) => {
                grid += `<div class="residue-box" onclick="this.querySelector('.residue-char').classList.toggle('masked')" title="Pos: ${i+1}">
                            <div class="residue-char">${aa}</div>
                            <div class="residue-num">${i+1}</div>
                         </div>`;
            });
            grid += `</div>`;

            const div = document.createElement('div');
            div.className = "bg-slate-50 rounded-lg border border-slate-200 p-4";
            div.id = wsId;
            div.innerHTML = `
                <div class="flex justify-between items-center mb-3 pb-2 border-b border-slate-100">
                    <h3 class="text-xs font-bold text-slate-500 uppercase">Design #${wsCount}</h3>
                    <div class="flex gap-2">
                        <button onclick="copyWs('${wsId}')" class="text-xs px-2 py-1 bg-white border rounded hover:bg-slate-100 font-medium">Copy Seq</button>
                        <button onclick="document.getElementById('${wsId}').remove()" class="text-xs text-red-400 px-2 hover:text-red-600">Remove</button>
                    </div>
                </div>
                ${grid}
            `;
            document.getElementById('workspaceContainer').prepend(div);
        }
        function copyWs(id) {
            let s = "";
            document.getElementById(id).querySelectorAll('.residue-char').forEach(c => s += c.classList.contains('masked') ? "_" : c.innerText);
            navigator.clipboard.writeText(s);
        }

        // --- 3. RARE CODON LOGIC (Kazusa E. coli K-12) ---
        // Data: E. coli K-12 MG1655 Codon Usage (Kazusa)
        // Value = Frequency per Thousand
        const kazusaEcoli = {
            'UUU': 22.3, 'UUC': 16.5, 'UUA': 13.7, 'UUG': 13.6,
            'CUU': 11.0, 'CUC': 11.1, 'CUA': 3.9,  'CUG': 52.9,
            'AUU': 30.4, 'AUC': 25.0, 'AUA': 4.5,  'AUG': 27.7,
            'GUU': 18.3, 'GUC': 15.2, 'GUA': 10.9, 'GUG': 26.3,
            'UCU': 8.5,  'UCC': 8.6,  'UCA': 7.1,  'UCG': 8.9,
            'CCU': 7.0,  'CCC': 5.5,  'CCA': 8.4,  'CCG': 23.2,
            'ACU': 8.9,  'ACC': 23.4, 'ACA': 7.1,  'ACG': 14.4,
            'GCU': 15.3, 'GCC': 25.5, 'GCA': 20.3, 'GCG': 33.7,
            'UAU': 16.2, 'UAC': 12.2, 'UAA': 2.0,  'UAG': 0.2,
            'CAU': 12.8, 'CAC': 9.7,  'CAA': 15.1, 'CAG': 29.0,
            'AAU': 17.6, 'AAC': 21.6, 'AAA': 33.2, 'AAG': 13.3,
            'GAU': 32.2, 'GAC': 19.1, 'GAA': 39.7, 'GAG': 17.8,
            'UGU': 5.2,  'UGC': 6.4,  'UGA': 0.9,  'UGG': 15.3,
            'CGU': 20.9, 'CGC': 22.0, 'CGA': 3.6,  'CGG': 5.4,
            'AGU': 8.7,  'AGC': 16.0, 'AGA': 2.1,  'AGG': 1.2,
            'GGU': 24.7, 'GGC': 29.6, 'GGA': 7.9,  'GGG': 11.0
        };

        function analyzeCodons() {
            const dna = document.getElementById('codonInput').value.replace(/[^ATGCatgc]/g, '').toUpperCase();
            const visual = document.getElementById('codonVisual');
            const report = document.getElementById('codonReport');
            
            if(!dna) {
                visual.innerHTML = "<span class='text-slate-400'>Sequence map will appear here...</span>";
                report.innerHTML = "<ul><li>Waiting...</li></ul>";
                return;
            }

            let mapHTML = "";
            let listHTML = "";
            let count = 0;

            for(let i=0; i<dna.length; i+=3) {
                let codon = dna.substr(i, 3);
                if(codon.length < 3) break;
                
                let freq = kazusaEcoli[codon];
                let isRare = freq < 10.0; // Threshold < 10 per thousand
                let pos = (i/3) + 1;

                if(isRare) {
                    count++;
                    mapHTML += `<span class="codon-rare px-1 rounded mx-0.5" title="Pos:${pos} ${codon} (${freq}‚Ä∞)">${codon}</span>`;
                    listHTML += `<li class="flex justify-between py-1 border-b border-slate-50">
                        <span><span class="font-bold text-red-500">${codon}</span> <span class="text-slate-400">@</span> ${pos}</span>
                        <span class="text-xs bg-red-100 text-red-600 px-2 rounded-full">${freq}‚Ä∞</span>
                    </li>`;
                } else {
                    mapHTML += `<span class="codon-normal opacity-50 mx-0.5">${codon}</span>`;
                }
            }
            
            visual.innerHTML = mapHTML;
            report.innerHTML = count > 0 
                ? `<div class="font-bold text-red-600 mb-2">Found ${count} rare codons</div><ul>${listHTML}</ul>`
                : `<div class="text-green-600 font-bold text-center mt-10">‚úì Excellent!<br>No rare codons found.</div>`;
        }
    </script>
</body>
</html>
