<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Molecular Workbench V8 (Hairpin DeltaG)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; color: #1e293b; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }

        /* --- SMART INPUT SYSTEM --- */
        .smart-input-container {
            position: relative; width: 100%; height: 120px;
            border: 1px solid #cbd5e1; border-radius: 8px; background: white; overflow: hidden;
        }
        .smart-input-container:focus-within {
            border-color: #3b82f6; ring: 2px; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        .smart-backdrop, .smart-textarea {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0; width: 100%; height: 100%;
            padding: 12px; font-family: 'JetBrains Mono', monospace; font-size: 14px; line-height: 1.5;
            white-space: pre-wrap; word-wrap: break-word; overflow: auto; margin: 0; border: none; outline: none; resize: none;
        }
        .smart-backdrop { z-index: 1; color: transparent; pointer-events: none; background: transparent; }
        .smart-textarea { z-index: 2; color: transparent; background: transparent; caret-color: black; }
        
        .c-A { color: #16a34a; font-weight: bold; }
        .c-T { color: #dc2626; font-weight: bold; }
        .c-G { color: #d97706; font-weight: bold; }
        .c-C { color: #2563eb; font-weight: bold; }
        .c-X { color: #cbd5e1; }

        /* Other Styles */
        .residue-box { width: 22px; margin: 1px; cursor: pointer; display: flex; flex-direction: column; align-items: center; }
        .residue-char { font-size: 0.9rem; font-weight: 700; width: 100%; text-align: center; border-radius: 4px; background: #e2e8f0; color: #334155; }
        .residue-char.masked { background-color: #475569; color: #fbbf24; text-decoration: line-through; opacity: 0.8; }
        .residue-num { font-size: 0.55rem; color: #94a3b8; margin-top: 2px; }
        .codon-rare { background-color: #fee2e2; color: #991b1b; font-weight: bold; border-bottom: 2px solid #ef4444; }
    </style>
</head>
<body class="p-4 md:p-8 max-w-7xl mx-auto min-h-screen">

    <header class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4 border-b border-slate-200 pb-4">
        <div>
            <h1 class="text-2xl font-bold text-slate-800 flex items-center gap-2">
                ðŸ§¬ Molecular Workbench <span class="text-xs bg-pink-600 text-white px-2 py-1 rounded">v8.0</span>
            </h1>
            <p class="text-slate-500 text-sm">Hairpin Analysis â€¢ Color Input â€¢ CSV Export</p>
        </div>
        <nav class="bg-white p-1 rounded-lg border border-slate-200 shadow-sm flex gap-1">
            <button onclick="switchTab('primer')" id="tab-primer" class="px-5 py-2 text-sm font-semibold rounded bg-pink-50 text-pink-700">Primer (Hairpin)</button>
            <button onclick="switchTab('protein')" id="tab-protein" class="px-5 py-2 text-sm font-medium rounded text-slate-500 hover:text-slate-700">Masking</button>
            <button onclick="switchTab('codon')" id="tab-codon" class="px-5 py-2 text-sm font-medium rounded text-slate-500 hover:text-slate-700">Rare Codon</button>
        </nav>
    </header>

    <main id="content-primer" class="tool-content">
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
            
            <div class="grid md:grid-cols-2 gap-6 mb-6">
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">Forward Primer</label>
                    <div class="smart-input-container">
                        <div id="fwdBackdrop" class="smart-backdrop"></div>
                        <textarea id="fwdInput" class="smart-textarea" spellcheck="false" placeholder="Paste Sequence..." oninput="handleInput('fwd')" onscroll="syncScroll('fwd')" onmouseup="checkSelect('fwd')" onkeyup="checkSelect('fwd')"></textarea>
                    </div>
                    <div id="fwdPreview" class="text-xs text-slate-400 mt-1 h-5 flex items-center">Highlight annealing part...</div>
                </div>

                <div>
                    <div class="flex justify-between mb-2">
                        <label class="block text-sm font-bold text-slate-700">Reverse Primer</label>
                        <button onclick="revCompTool()" class="text-[10px] bg-slate-100 px-2 rounded border hover:bg-pink-50 hover:text-pink-600">â†º RevComp</button>
                    </div>
                    <div class="smart-input-container">
                        <div id="revBackdrop" class="smart-backdrop"></div>
                        <textarea id="revInput" class="smart-textarea" spellcheck="false" placeholder="Paste Sequence..." oninput="handleInput('rev')" onscroll="syncScroll('rev')" onmouseup="checkSelect('rev')" onkeyup="checkSelect('rev')"></textarea>
                    </div>
                    <div id="revPreview" class="text-xs text-slate-400 mt-1 h-5 flex items-center">Highlight annealing part...</div>
                </div>
            </div>

            <div class="flex flex-col md:flex-row gap-4 items-end justify-between bg-slate-50 p-4 rounded-lg border border-slate-200 mb-6">
                <div class="w-full md:w-1/3">
                    <label class="text-xs font-bold text-slate-500 uppercase">Primer Pair Name</label>
                    <input type="text" id="primerName" class="w-full p-2 border border-slate-300 rounded text-sm focus:border-pink-500 outline-none" placeholder="e.g. geneA_cloning">
                </div>
                <button onclick="addPair()" class="w-full md:w-auto px-6 py-2 bg-pink-600 hover:bg-pink-700 text-white font-bold rounded shadow transition">
                    + Add to Table
                </button>
            </div>

            <div class="flex justify-between items-center mb-2">
                <h3 class="text-sm font-bold text-slate-700">Order List</h3>
                <button onclick="exportCSV()" class="text-xs flex items-center gap-1 bg-green-600 text-white px-3 py-1.5 rounded hover:bg-green-700 transition shadow-sm">
                    ðŸ“„ Export CSV
                </button>
            </div>
            
            <div class="overflow-x-auto border border-slate-200 rounded-lg">
                <table class="w-full text-left text-sm">
                    <thead class="bg-slate-50 text-slate-500 font-semibold border-b border-slate-200 text-xs uppercase">
                        <tr>
                            <th class="px-4 py-3">Name</th>
                            <th class="px-4 py-3">Type</th>
                            <th class="px-4 py-3">Sequence</th>
                            <th class="px-4 py-3 w-16">Len</th>
                            <th class="px-4 py-3 w-16">Tm</th>
                            <th class="px-4 py-3 w-24 bg-pink-50/50">Hp Î”G</th>
                            <th class="px-4 py-3 w-10"></th>
                        </tr>
                    </thead>
                    <tbody id="primerTable" class="bg-white divide-y divide-slate-100 font-mono text-xs text-slate-600">
                        </tbody>
                </table>
                <div id="emptyMsg" class="p-6 text-center text-slate-400 italic text-sm">No primers added yet.</div>
            </div>
        </div>
    </main>

    <main id="content-protein" class="tool-content hidden">
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
            <h2 class="text-xl font-bold text-slate-800 mb-4">ðŸŽ­ Protein Masking</h2>
            <div class="flex gap-3 mb-6">
                <input id="protSeq" type="text" class="flex-1 p-3 border border-slate-300 rounded text-sm font-mono uppercase" placeholder="Paste Amino Acid Sequence..." oninput="this.value=this.value.replace(/[^a-zA-Z]/g,'').toUpperCase()">
                <button onclick="addWorkspace()" class="px-5 py-2 bg-slate-800 text-white rounded font-bold hover:bg-slate-900">+ New Box</button>
            </div>
            <div id="maskContainer" class="space-y-6"></div>
        </div>
    </main>

    <main id="content-codon" class="tool-content hidden">
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
            <h2 class="text-xl font-bold text-slate-800 mb-2">ðŸ¦  Rare Codon (Relative)</h2>
            <textarea id="codonInput" class="w-full p-3 border border-slate-200 rounded font-mono text-sm mb-4 h-24" placeholder="Paste DNA..." oninput="analyzeCodons()"></textarea>
            <div id="codonVisual" class="p-4 bg-slate-50 border border-slate-200 rounded font-mono text-sm break-all leading-loose text-slate-400 min-h-[100px]">Result map...</div>
        </div>
    </main>

    <script>
        // --- GLOBAL STATE ---
        let primerList = [];

        // --- 1. SMART INPUT SYSTEM ---
        function handleInput(id) {
            const input = document.getElementById(id+'Input');
            const backdrop = document.getElementById(id+'Backdrop');
            const val = input.value;
            const colored = val.replace(/./g, (char) => {
                const c = char.toUpperCase();
                if(c === 'A') return '<span class="c-A">A</span>';
                if(c === 'T') return '<span class="c-T">T</span>';
                if(c === 'G') return '<span class="c-G">G</span>';
                if(c === 'C') return '<span class="c-C">C</span>';
                if(/\s/.test(char)) return char; 
                return `<span class="c-X">${char}</span>`;
            });
            backdrop.innerHTML = colored + '<br>';
        }
        function syncScroll(id) {
            const input = document.getElementById(id+'Input');
            document.getElementById(id+'Backdrop').scrollTop = input.scrollTop;
            document.getElementById(id+'Backdrop').scrollLeft = input.scrollLeft;
        }

        // --- 2. HAIRPIN DELTA G ENGINE ---
        function calcHairpin(seq) {
            // Heuristic to find the most stable hairpin (lowest deltaG)
            // Simplified approximation for checking stem-loop formation
            if(seq.length < 4) return 0;
            const s = seq.toUpperCase();
            let minDg = 0; // 0 means stable (no hairpin)

            // Loop size >= 3 bases
            for(let i=0; i < s.length-4; i++) { // i = start of stem 1
                for(let j=i+4; j < s.length; j++) { // j = start of stem 2 (comp)
                    // Check complementarity backwards from j vs forward from i
                    let k=0;
                    let stemDg = 0;
                    // Check pairs
                    while(i+k < j-k) {
                        const b1 = s[i+k];
                        const b2 = s[j-k];
                        const pair = b1+b2;
                        
                        let pairDg = 0;
                        if(pair=='GC'||pair=='CG') pairDg = -2.2;
                        else if(pair=='AT'||pair=='TA') pairDg = -1.0;
                        else if(pair=='GT'||pair=='TG') pairDg = -0.5; // Wobble
                        else break; // Break stem

                        stemDg += pairDg;
                        k++;
                    }

                    if(k >= 2) { // Minimum stem length 2
                        // Add Loop Penalty (approx +1.5 to +3.0 based on size)
                        const loopSize = (j-k) - (i+k) + 1;
                        let loopPen = 1.5 + (loopSize * 0.1); 
                        if (loopSize > 10) loopPen += 1;

                        const totalDg = stemDg + loopPen;
                        if(totalDg < minDg) minDg = totalDg;
                    }
                }
            }
            return minDg.toFixed(1);
        }

        let curSel = { fwd: null, rev: null };

        function checkSelect(id) {
            const input = document.getElementById(id+'Input');
            const text = input.value.substring(input.selectionStart, input.selectionEnd).replace(/[^a-zA-Z]/g, '').toUpperCase();
            const preview = document.getElementById(id+'Preview');
            
            if(text.length > 5) {
                const tm = (64.9 + 41*((text.match(/[GC]/g)||[]).length - 16.4)/text.length).toFixed(1);
                const hpDg = calcHairpin(text); // Calculate Hairpin DeltaG
                
                let colorClass = "text-green-600"; // Safe
                if(hpDg < -5) colorClass = "text-red-600 font-bold"; // Bad
                else if(hpDg < -2) colorClass = "text-orange-500 font-bold"; // Risk

                preview.innerHTML = `<span class="bg-slate-100 px-1 rounded">${text}</span> (Tm:${tm}Â°, Hp Î”G: <span class="${colorClass}">${hpDg}</span>)`;
                curSel[id] = { seq: text, tm: tm, hpDg: hpDg, len: text.length };
            } else {
                preview.innerHTML = "Highlight annealing part...";
                curSel[id] = null;
            }
        }

        function addPair() {
            if(!curSel.fwd || !curSel.rev) return alert("Highlight annealing part for both primers.");
            const nameBase = document.getElementById('primerName').value.trim() || `Pair_${primerList.length/2 + 1}`;
            document.getElementById('emptyMsg').style.display = 'none';

            ['fwd','rev'].forEach(type => {
                const p = curSel[type];
                const typeLabel = type.toUpperCase();
                const obj = { name: nameBase + "_" + (type=='fwd'?'F':'R'), type: typeLabel, ...p };
                primerList.push(obj);
                
                // Color Logic
                let dgColor = "text-green-600";
                let badge = "";
                if(p.hpDg < -5) { dgColor = "text-red-600 font-bold"; badge="âš ï¸"; }
                else if(p.hpDg < -2) { dgColor = "text-orange-500 font-bold"; }

                const row = document.getElementById('primerTable').insertRow();
                row.className = "hover:bg-slate-50";
                row.innerHTML = `
                    <td class="px-4 py-2 font-bold text-slate-700">${obj.name}</td>
                    <td class="px-4 py-2"><span class="bg-slate-200 text-slate-600 px-1 rounded text-[10px]">${obj.type}</span></td>
                    <td class="px-4 py-2 break-all text-[11px]">${obj.seq}</td>
                    <td class="px-4 py-2">${obj.len}</td>
                    <td class="px-4 py-2 font-bold">${obj.tm}Â°</td>
                    <td class="px-4 py-2 ${dgColor}">${obj.hpDg} ${badge}</td>
                    <td class="px-4 py-2"><button onclick="removeRow(this, '${obj.name}')" class="text-red-400 hover:text-red-600">Ã—</button></td>
                `;
            });
        }

        function removeRow(btn, name) {
            btn.closest('tr').remove();
            primerList = primerList.filter(p => p.name !== name);
        }

        function exportCSV() {
            if(primerList.length === 0) return alert("No primers.");
            let csv = "data:text/csv;charset=utf-8,Name,Type,Sequence,Length,Tm,Hairpin_DeltaG\n";
            primerList.forEach(p => csv += `${p.name},${p.type},${p.seq},${p.len},${p.tm},${p.hpDg}\r\n`);
            const link = document.createElement("a");
            link.href = encodeURI(csv);
            link.download = "primers_order_hairpin_check.csv";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- 3. HELPERS & OTHER TOOLS ---
        function revCompTool() {
            const el = document.getElementById('revInput'); if(!el.value)return;
            const map = {'A':'T','T':'A','G':'C','C':'G','a':'t','t':'a','g':'c','c':'g'};
            el.value = el.value.split('').reverse().join('').replace(/[ATGCatgc]/g, b=>map[b]||b).toUpperCase();
            handleInput('rev');
        }
        function addWorkspace() { /* Protein Masking Logic (Same as V7) */ 
            const seq = document.getElementById('protSeq').value; if(!seq) return;
            const id = `ws-${Date.now()}`;
            let h = `<div class="bg-slate-50 border border-slate-200 rounded-lg p-4 relative" id="${id}"><div class="flex justify-between mb-2"><span class="text-xs font-bold text-slate-400">Design</span><div class="flex gap-2"><button onclick="copyMasked('${id}')" class="text-xs bg-white border px-2 py-1 rounded hover:bg-blue-50 text-blue-600 font-bold">ðŸ“‹ Copy Seq</button><button onclick="document.getElementById('${id}').remove()" class="text-xs text-red-300 hover:text-red-500">Remove</button></div></div><div class="flex flex-wrap gap-0.5">`;
            seq.split('').forEach((c,i)=>h+=`<div class="residue-box" onclick="this.querySelector('.residue-char').classList.toggle('masked')"><div class="residue-char">${c}</div><div class="residue-num">${i+1}</div></div>`);
            document.getElementById('maskContainer').insertAdjacentHTML('afterbegin', h+`</div></div>`);
        }
        function copyMasked(id){ 
            let s=""; document.getElementById(id).querySelectorAll('.residue-char:not(.masked)').forEach(e=>s+=e.innerText);
            navigator.clipboard.writeText(s).then(()=>alert("Copied!"));
        }
        function analyzeCodons() { /* Rare Codon Logic (Same as V7) */
             const dna = document.getElementById('codonInput').value.toUpperCase().replace(/[^ATGC]/g,'');
             const map={'TTT':'F','TTC':'F','TTA':'L','TTG':'L','CTT':'L','CTC':'L','CTA':'L','CTG':'L','ATT':'I','ATC':'I','ATA':'I','ATG':'M','GTT':'V','GTC':'V','GTA':'V','GTG':'V','TCT':'S','TCC':'S','TCA':'S','TCG':'S','CCT':'P','CCC':'P','CCA':'P','CCG':'P','ACT':'T','ACC':'T','ACA':'T','ACG':'T','GCT':'A','GCC':'A','GCA':'A','GCG':'A','TAT':'Y','TAC':'Y','TAA':'*','TAG':'*','CAT':'H','CAC':'H','CAA':'Q','CAG':'Q','AAT':'N','AAC':'N','AAA':'K','AAG':'K','GAT':'D','GAC':'D','GAA':'E','GAG':'E','TGT':'C','TGC':'C','TGA':'*','TGG':'W','CGT':'R','CGC':'R','CGA':'R','CGG':'R','AGT':'S','AGC':'S','AGA':'R','AGG':'R','GGT':'G','GGC':'G','GGA':'G','GGG':'G'};
             const freq={'TTT':22.3,'TTC':16.5,'TTA':13.7,'TTG':13.6,'CTT':11.0,'CTC':11.1,'CTA':3.9,'CTG':52.9,'ATT':30.4,'ATC':25.0,'ATA':4.5,'ATG':27.7,'GTT':18.3,'GTC':15.2,'GTA':10.9,'GTG':26.3,'TCT':8.5,'TCC':8.6,'TCA':7.1,'TCG':8.9,'CCT':7.0,'CCC':5.5,'CCA':8.4,'CCG':23.2,'ACT':8.9,'ACC':23.4,'ACA':7.1,'ACG':14.4,'GCT':15.3,'GCC':25.5,'GCA':20.3,'GCG':33.7,'TAT':16.2,'TAC':12.2,'TAA':2.0,'TAG':0.2,'CAT':12.8,'CAC':9.7,'CAA':15.1,'CAG':29.0,'AAT':17.6,'AAC':21.6,'AAA':33.2,'AAG':13.3,'GAT':32.2,'GAC':19.1,'GAA':39.7,'GAG':17.8,'TGT':5.2,'TGC':6.4,'TGA':0.9,'TGG':15.3,'CGT':20.9,'CGC':22.0,'CGA':3.6,'CGG':5.4,'AGT':8.7,'AGC':16.0,'AGA':2.1,'AGG':1.2,'GGT':24.7,'GGC':29.6,'GGA':7.9,'GGG':11.0};
             const max={}; Object.keys(map).forEach(c=>{ if(!max[map[c]] || freq[c]>max[map[c]]) max[map[c]]=freq[c]; });
             let h="";
             for(let i=0;i<dna.length;i+=3){
                 const c=dna.substr(i,3); if(c.length<3)break;
                 const r=(freq[c]||0)/(max[map[c]]||1);
                 h += r<0.1 ? `<span class="codon-rare" title="Rare!">${c}</span> ` : `<span class="text-slate-300">${c}</span> `;
             }
             document.getElementById('codonVisual').innerHTML = h||"Result map...";
        }
        function switchTab(t) { document.querySelectorAll('.tool-content').forEach(e=>e.classList.add('hidden')); document.getElementById('content-'+t).classList.remove('hidden'); }
    </script>
</body>
</html>
