<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Molecular Workbench V11 (Perfect UX)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #334155; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }

        /* --- SMART INPUT SYSTEM --- */
        .smart-input-container {
            position: relative; width: 100%; height: 120px;
            border: 1px solid #cbd5e1; border-radius: 8px; background: white; overflow: hidden;
        }
        .smart-input-container:focus-within {
            border-color: #4f46e5; ring: 2px; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
        }
        .smart-backdrop, .smart-textarea {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0; width: 100%; height: 100%;
            padding: 12px; font-family: 'JetBrains Mono', monospace; font-size: 14px; line-height: 1.6;
            white-space: pre-wrap; word-wrap: break-word; overflow: auto; margin: 0; border: none; outline: none; resize: none;
        }
        
        /* Layer 1: The Colors */
        .smart-backdrop { z-index: 1; color: transparent; pointer-events: none; background: transparent; }
        
        /* Layer 2: The Input & Selection */
        .smart-textarea { z-index: 2; color: transparent; background: transparent; caret-color: black; }
        
        /* --- KEY FIX: VISIBLE SELECTION --- */
        /* Make the selection background semi-transparent so the backdrop colors show through */
        .smart-textarea::selection { background-color: rgba(99, 102, 241, 0.25); } 

        /* Color Mapping */
        .c-A { color: #16a34a; font-weight: bold; }
        .c-T { color: #dc2626; font-weight: bold; }
        .c-G { color: #d97706; font-weight: bold; }
        .c-C { color: #2563eb; font-weight: bold; }
        .c-X { color: #cbd5e1; }

        /* Tab States */
        .tab-btn { transition: all 0.2s; }
        .tab-active { background-color: #4f46e5; color: white; box-shadow: 0 2px 4px rgba(79, 70, 229, 0.3); }
        .tab-inactive { background-color: white; color: #64748b; border: 1px solid #e2e8f0; }

        /* Protein Box */
        .residue-box { width: 24px; margin: 2px; cursor: pointer; display: flex; flex-direction: column; align-items: center; }
        .residue-char { 
            font-size: 1rem; font-weight: 700; width: 100%; text-align: center; border-radius: 4px; 
            background: #e2e8f0; color: #334155; transition: transform 0.1s;
        }
        .residue-char:hover { transform: scale(1.1); z-index: 10; }
        .residue-char.masked { background-color: #ef4444; color: white; opacity: 0.5; }
        .residue-num { font-size: 0.6rem; color: #94a3b8; margin-top: 2px; }

        /* Rare Codon Layout */
        .codon-row { display: flex; align-items: baseline; margin-bottom: 4px; }
        .codon-index { width: 40px; flex-shrink: 0; color: #94a3b8; font-size: 0.7rem; text-align: right; margin-right: 12px; user-select: none; }
        .codon-seq { display: flex; flex-wrap: wrap; gap: 2px; }
        .codon-span { 
            padding: 0 2px; border-radius: 2px; font-size: 0.8rem;
            transition: all 0.1s; cursor: default;
        }
        .codon-span:hover { background: #e0e7ff; z-index: 10; transform: scale(1.1); }
        .codon-rare { 
            background-color: #fee2e2; color: #b91c1c; font-weight: bold; 
            border-bottom: 2px solid #ef4444; 
        }
        .codon-ok { color: #64748b; }
    </style>
</head>
<body class="p-4 md:p-8 max-w-7xl mx-auto min-h-screen">

    <header class="mb-6 border-b border-slate-200 pb-4">
        <div class="flex flex-col md:flex-row justify-between items-center gap-4">
            <div>
                <h1 class="text-2xl font-bold text-slate-800 flex items-center gap-2">
                    üß¨ Molecular Workbench <span class="text-xs bg-indigo-600 text-white px-2 py-1 rounded">v11.0</span>
                </h1>
                <p class="text-slate-500 text-sm">Visual Selection ‚Ä¢ Line Numbers ‚Ä¢ Silent Copy</p>
            </div>
            
            <nav class="flex gap-2">
                <button onclick="switchTab('primer')" id="btn-primer" class="tab-btn tab-active px-6 py-2 rounded-lg text-sm font-bold">Primer Design</button>
                <button onclick="switchTab('protein')" id="btn-protein" class="tab-btn tab-inactive px-6 py-2 rounded-lg text-sm font-bold">Masking</button>
                <button onclick="switchTab('codon')" id="btn-codon" class="tab-btn tab-inactive px-6 py-2 rounded-lg text-sm font-bold">Rare Codon</button>
            </nav>
        </div>
    </header>

    <main id="content-primer" class="tool-content">
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
            
            <div class="grid md:grid-cols-2 gap-6 mb-6">
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">Forward Primer (5'‚ûù3')</label>
                    <div class="smart-input-container">
                        <div id="fwdBackdrop" class="smart-backdrop"></div>
                        <textarea id="fwdInput" class="smart-textarea" spellcheck="false" 
                            placeholder="Paste Sequence..." 
                            oninput="handleInput('fwd')" onscroll="syncScroll('fwd')" 
                            onmouseup="checkSelect('fwd')" onkeyup="checkSelect('fwd')"></textarea>
                    </div>
                    <div id="fwdStatus" class="mt-1 text-xs text-slate-400 italic h-5">Highlight annealing part to check Tm...</div>
                </div>

                <div>
                    <div class="flex justify-between mb-2">
                        <label class="block text-sm font-bold text-slate-700">Reverse Primer (5'‚ûù3')</label>
                        <button onclick="revCompTool()" class="text-[10px] bg-slate-100 px-2 rounded border hover:bg-indigo-50 hover:text-indigo-600">‚Ü∫ RevComp Tool</button>
                    </div>
                    <div class="smart-input-container">
                        <div id="revBackdrop" class="smart-backdrop"></div>
                        <textarea id="revInput" class="smart-textarea" spellcheck="false" 
                            placeholder="Paste Sequence..." 
                            oninput="handleInput('rev')" onscroll="syncScroll('rev')"
                            onmouseup="checkSelect('rev')" onkeyup="checkSelect('rev')"></textarea>
                    </div>
                    <div id="revStatus" class="mt-1 text-xs text-slate-400 italic h-5">Highlight annealing part to check Tm...</div>
                </div>
            </div>

            <div class="flex flex-col md:flex-row gap-4 items-end justify-between bg-slate-50 p-4 rounded-lg border border-slate-200 mb-6">
                <div class="w-full md:w-1/3">
                    <label class="text-xs font-bold text-slate-500 uppercase">Primer Pair Name</label>
                    <input type="text" id="primerName" class="w-full p-2 border border-slate-300 rounded text-sm focus:border-indigo-500 outline-none" placeholder="e.g. pET28a-GeneX">
                </div>
                <button onclick="addPair()" class="w-full md:w-auto px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded shadow transition">
                    + Add to Table & Reset
                </button>
            </div>

            <div class="flex justify-between items-center mb-2">
                <h3 class="text-sm font-bold text-slate-700">Order List</h3>
                <button onclick="exportCSV()" class="text-xs flex items-center gap-1 bg-green-600 text-white px-3 py-1.5 rounded hover:bg-green-700 transition shadow-sm font-bold">
                    üìÑ Export CSV (Name & Seq Only)
                </button>
            </div>
            
            <div class="overflow-x-auto border border-slate-200 rounded-lg">
                <table class="w-full text-left text-sm">
                    <thead class="bg-slate-50 text-slate-500 font-semibold border-b border-slate-200 text-xs uppercase">
                        <tr>
                            <th class="px-4 py-3">Name</th>
                            <th class="px-4 py-3">Type</th>
                            <th class="px-4 py-3">Full Sequence</th>
                            <th class="px-4 py-3 w-16">Len</th>
                            <th class="px-4 py-3 w-16">Tm</th>
                            <th class="px-4 py-3 w-20">Hp ŒîG</th>
                            <th class="px-4 py-3 w-10"></th>
                        </tr>
                    </thead>
                    <tbody id="primerTable" class="bg-white divide-y divide-slate-100 font-mono text-xs">
                        </tbody>
                </table>
                <div id="emptyMsg" class="p-6 text-center text-slate-400 italic text-sm">No primers added yet.</div>
            </div>
        </div>
    </main>

    <main id="content-protein" class="tool-content hidden">
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
            <h2 class="text-xl font-bold text-slate-800 mb-4">üé≠ Protein Masking</h2>
            <div class="flex gap-3 mb-6">
                <input id="protSeq" type="text" class="flex-1 p-3 border border-slate-300 rounded text-sm font-mono uppercase" placeholder="Paste Amino Acid Sequence..." oninput="this.value=this.value.replace(/[^a-zA-Z]/g,'').toUpperCase()">
                <button onclick="addWorkspace()" class="px-5 py-2 bg-slate-800 text-white rounded font-bold hover:bg-slate-900">+ New Box</button>
            </div>
            <div id="maskContainer" class="space-y-6"></div>
        </div>
    </main>

    <main id="content-codon" class="tool-content hidden">
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
            <h2 class="text-xl font-bold text-slate-800 mb-2">ü¶† Rare Codon Map</h2>
            <p class="text-xs text-slate-500 mb-4">Organism: E. coli K-12 (Threshold < 10%)</p>
            <textarea id="codonInput" class="w-full p-3 border border-slate-200 rounded font-mono text-sm mb-4 h-24" placeholder="Paste DNA sequence here..." oninput="analyzeCodons()"></textarea>
            
            <div class="p-6 bg-white border border-slate-200 rounded-lg shadow-inner min-h-[150px] overflow-x-auto">
                <div id="codonVisual" class="font-mono text-xs">
                    <span class="text-slate-300 italic">Sequence map will appear here...</span>
                </div>
            </div>
        </div>
    </main>

    <script>
        // --- GLOBAL & TABS ---
        let primerList = [];

        function switchTab(t) {
            document.querySelectorAll('.tool-content').forEach(e => e.classList.add('hidden'));
            document.getElementById('content-'+t).classList.remove('hidden');
            ['primer', 'protein', 'codon'].forEach(tab => {
                const btn = document.getElementById('btn-'+tab);
                btn.className = (tab === t) ? 'tab-btn tab-active px-6 py-2 rounded-lg text-sm font-bold' : 'tab-btn tab-inactive px-6 py-2 rounded-lg text-sm font-bold';
            });
        }

        function colorizeHTML(seq) {
            return seq.replace(/./g, (char) => {
                const c = char.toUpperCase();
                if(c === 'A') return '<span class="c-A">A</span>';
                if(c === 'T') return '<span class="c-T">T</span>';
                if(c === 'G') return '<span class="c-G">G</span>';
                if(c === 'C') return '<span class="c-C">C</span>';
                return `<span class="c-X">${char}</span>`;
            });
        }

        // --- 1. PRIMER LOGIC ---
        function handleInput(id) {
            const input = document.getElementById(id+'Input');
            const backdrop = document.getElementById(id+'Backdrop');
            backdrop.innerHTML = colorizeHTML(input.value) + '<br>';
        }

        function syncScroll(id) {
            const input = document.getElementById(id+'Input');
            const backdrop = document.getElementById(id+'Backdrop');
            backdrop.scrollTop = input.scrollTop;
            backdrop.scrollLeft = input.scrollLeft;
        }

        function calcHairpin(seq) {
            if(seq.length < 4) return 0;
            const s = seq.toUpperCase();
            let minDg = 0;
            for(let i=0; i<s.length-4; i++) {
                for(let j=i+4; j<s.length; j++) {
                    let k=0, stemDg=0;
                    while(i+k < j-k) {
                        const pair = s[i+k]+s[j-k];
                        if(pair=='GC'||pair=='CG') stemDg -= 2.2;
                        else if(pair=='AT'||pair=='TA') stemDg -= 1.0;
                        else if(pair=='GT'||pair=='TG') stemDg -= 0.5;
                        else break;
                        k++;
                    }
                    if(k>=2) {
                        let loopPen = 1.5 + ((j-k)-(i+k)+1)*0.1;
                        if(stemDg + loopPen < minDg) minDg = stemDg + loopPen;
                    }
                }
            }
            return minDg.toFixed(1);
        }

        let curSel = { fwd: null, rev: null };

        function checkSelect(id) {
            const input = document.getElementById(id+'Input');
            const fullSeq = input.value.replace(/[^a-zA-Z]/g, '').toUpperCase();
            const selText = input.value.substring(input.selectionStart, input.selectionEnd).replace(/[^a-zA-Z]/g, '').toUpperCase();
            const status = document.getElementById(id+'Status');
            
            if(selText.length > 5) {
                const tm = (64.9 + 41*((selText.match(/[GC]/g)||[]).length - 16.4)/selText.length).toFixed(1);
                const hpDg = calcHairpin(selText);
                
                let dgColor = "text-green-600";
                if(hpDg < -5) dgColor = "text-red-600 font-bold";
                else if(hpDg < -2) dgColor = "text-orange-500 font-bold";

                status.innerHTML = `<span class="text-indigo-600 font-bold">Selected: ${selText.length} bp</span> | Tm: ${tm}¬∞ | Hp: <span class="${dgColor}">${hpDg}</span>`;
                curSel[id] = { fullSeq: fullSeq, annealing: selText, tm: tm, hpDg: hpDg, len: fullSeq.length };
            } else {
                status.innerHTML = "Highlight annealing part to check Tm...";
                curSel[id] = null;
            }
        }

        function addPair() {
            if(!curSel.fwd || !curSel.rev) return alert("Please HIGHLIGHT the annealing part for both primers.");
            
            const nameBase = document.getElementById('primerName').value.trim() || `Pair_${primerList.length/2 + 1}`;
            document.getElementById('emptyMsg').style.display = 'none';

            ['fwd','rev'].forEach(type => {
                const p = curSel[type];
                const typeName = type=='fwd'?'F':'R';
                const obj = { name: nameBase + "_" + typeName, type: type.toUpperCase(), ...p };
                primerList.push(obj);
                
                let badge = "";
                if(p.hpDg < -5) badge="‚ö†Ô∏è";

                const tbody = document.getElementById('primerTable');
                const row = tbody.insertRow();
                row.className = "hover:bg-slate-50 transition-colors border-b border-slate-100";
                row.innerHTML = `
                    <td class="px-4 py-3 font-bold text-slate-700">${obj.name}</td>
                    <td class="px-4 py-3"><span class="bg-slate-100 text-slate-500 px-1.5 py-0.5 rounded text-[10px] font-bold border border-slate-200">${obj.type}</span></td>
                    <td class="px-4 py-3 break-all text-[11px] font-mono leading-tight bg-slate-50/50 rounded">${colorizeHTML(obj.fullSeq)}</td>
                    <td class="px-4 py-3">${obj.len}</td>
                    <td class="px-4 py-3 font-bold">${obj.tm}¬∞</td>
                    <td class="px-4 py-3 ${p.hpDg < -2 ? 'text-red-600 font-bold' : 'text-green-600'}">${obj.hpDg} ${badge}</td>
                    <td class="px-4 py-3"><button onclick="removeRow(this, '${obj.name}')" class="text-red-300 hover:text-red-500 text-lg">√ó</button></td>
                `;
            });

            // RESET
            document.getElementById('fwdInput').value = "";
            document.getElementById('revInput').value = "";
            document.getElementById('primerName').value = "";
            handleInput('fwd'); handleInput('rev');
            document.getElementById('fwdStatus').innerHTML = "Highlight annealing part to check Tm...";
            document.getElementById('revStatus').innerHTML = "Highlight annealing part to check Tm...";
            curSel = { fwd: null, rev: null };
        }

        function removeRow(btn, name) {
            btn.closest('tr').remove();
            primerList = primerList.filter(p => p.name !== name);
        }

        function exportCSV() {
            if(primerList.length === 0) return alert("No primers.");
            let csv = "data:text/csv;charset=utf-8,Name,Sequence\n";
            primerList.forEach(p => csv += `${p.name},${p.fullSeq}\r\n`);
            const link = document.createElement("a");
            link.href = encodeURI(csv);
            link.download = "primers_order_full.csv";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function revCompTool() {
            const el = document.getElementById('revInput'); if(!el.value)return;
            const map = {'A':'T','T':'A','G':'C','C':'G','a':'t','t':'a','g':'c','c':'g'};
            el.value = el.value.split('').reverse().join('').replace(/[ATGCatgc]/g, b=>map[b]||b).toUpperCase();
            handleInput('rev');
        }

        // --- 2. PROTEIN MASKING (Silent Copy) ---
        function addWorkspace() {
            const seq = document.getElementById('protSeq').value; if(!seq) return;
            const id = `ws-${Date.now()}`;
            let h = `<div class="bg-white border border-slate-200 shadow-sm rounded-lg p-4 relative" id="${id}">
                <div class="flex justify-end mb-3 border-b border-slate-100 pb-2 gap-2">
                    <button id="copyBtn-${id}" onclick="copyMasked('${id}')" class="text-xs bg-indigo-50 px-3 py-1 rounded text-indigo-700 font-bold hover:bg-indigo-100 transition min-w-[100px]">üìã Copy (with _ )</button>
                    <button onclick="document.getElementById('${id}').remove()" class="text-xs text-red-400 hover:text-red-600 border border-transparent hover:border-red-100 px-2 rounded">Remove</button>
                </div>
                <div class="flex flex-wrap gap-1">`;
            
            seq.split('').forEach((c,i)=>h+=`<div class="residue-box" title="Pos: ${i+1}" onclick="this.querySelector('.residue-char').classList.toggle('masked')">
                <div class="residue-char">${c}</div>
                <div class="residue-num">${i+1}</div>
            </div>`);
            
            document.getElementById('maskContainer').insertAdjacentHTML('afterbegin', h+`</div></div>`);
        }

        function copyMasked(id) {
            let s = "";
            document.getElementById(id).querySelectorAll('.residue-box').forEach(box => {
                const charEl = box.querySelector('.residue-char');
                s += charEl.classList.contains('masked') ? "_" : charEl.innerText;
            });
            navigator.clipboard.writeText(s).then(() => {
                // Button Feedback (No Alert)
                const btn = document.getElementById('copyBtn-'+id);
                const originalText = btn.innerText;
                btn.innerText = "‚úÖ Copied!";
                btn.classList.add("bg-green-100", "text-green-700");
                setTimeout(() => {
                    btn.innerText = originalText;
                    btn.classList.remove("bg-green-100", "text-green-700");
                }, 1500);
            });
        }

        // --- 3. RARE CODON (With Line Numbers) ---
        function analyzeCodons() {
            const dna = document.getElementById('codonInput').value.toUpperCase().replace(/[^ATGC]/g,'');
            const map={'TTT':'F','TTC':'F','TTA':'L','TTG':'L','CTT':'L','CTC':'L','CTA':'L','CTG':'L','ATT':'I','ATC':'I','ATA':'I','ATG':'M','GTT':'V','GTC':'V','GTA':'V','GTG':'V','TCT':'S','TCC':'S','TCA':'S','TCG':'S','CCT':'P','CCC':'P','CCA':'P','CCG':'P','ACT':'T','ACC':'T','ACA':'T','ACG':'T','GCT':'A','GCC':'A','GCA':'A','GCG':'A','TAT':'Y','TAC':'Y','TAA':'*','TAG':'*','CAT':'H','CAC':'H','CAA':'Q','CAG':'Q','AAT':'N','AAC':'N','AAA':'K','AAG':'K','GAT':'D','GAC':'D','GAA':'E','GAG':'E','TGT':'C','TGC':'C','TGA':'*','TGG':'W','CGT':'R','CGC':'R','CGA':'R','CGG':'R','AGT':'S','AGC':'S','AGA':'R','AGG':'R','GGT':'G','GGC':'G','GGA':'G','GGG':'G'};
            const freq={'TTT':22.3,'TTC':16.5,'TTA':13.7,'TTG':13.6,'CTT':11.0,'CTC':11.1,'CTA':3.9,'CTG':52.9,'ATT':30.4,'ATC':25.0,'ATA':4.5,'ATG':27.7,'GTT':18.3,'GTC':15.2,'GTA':10.9,'GTG':26.3,'TCT':8.5,'TCC':8.6,'TCA':7.1,'TCG':8.9,'CCT':7.0,'CCC':5.5,'CCA':8.4,'CCG':23.2,'ACT':8.9,'ACC':23.4,'ACA':7.1,'ACG':14.4,'GCT':15.3,'GCC':25.5,'GCA':20.3,'GCG':33.7,'TAT':16.2,'TAC':12.2,'TAA':2.0,'TAG':0.2,'CAT':12.8,'CAC':9.7,'CAA':15.1,'CAG':29.0,'AAT':17.6,'AAC':21.6,'AAA':33.2,'AAG':13.3,'GAT':32.2,'GAC':19.1,'GAA':39.7,'GAG':17.8,'TGT':5.2,'TGC':6.4,'TGA':0.9,'TGG':15.3,'CGT':20.9,'CGC':22.0,'CGA':3.6,'CGG':5.4,'AGT':8.7,'AGC':16.0,'AGA':2.1,'AGG':1.2,'GGT':24.7,'GGC':29.6,'GGA':7.9,'GGG':11.0};
            const max={}; Object.keys(map).forEach(c=>{ if(!max[map[c]] || freq[c]>max[map[c]]) max[map[c]]=freq[c]; });
            
            let html = "";
            let codonsPerLine = 20; // 60 bp per line
            
            // Chunking
            let chunks = [];
            for (let i = 0; i < dna.length; i += 3) {
                chunks.push(dna.substr(i, 3));
            }
            
            // Building Rows
            for(let i=0; i < chunks.length; i += codonsPerLine) {
                const rowCodons = chunks.slice(i, i + codonsPerLine);
                const startPos = (i * 3) + 1;
                
                let rowHtml = `<div class="codon-row">`;
                rowHtml += `<div class="codon-index">${startPos}</div>`; // Line Number
                rowHtml += `<div class="codon-seq">`;
                
                rowCodons.forEach(c => {
                    if(c.length < 3
