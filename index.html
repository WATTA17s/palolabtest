<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Molecular Workbench V25 (Refined)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; color: #334155; }
        .font-mono { font-family: 'Roboto Mono', monospace; }

        /* NAVIGATION */
        .nav-btn { padding: 8px 16px; border-radius: 6px; font-weight: 600; font-size: 14px; transition: all 0.2s; }
        .nav-active { background: #2563eb; color: white; box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.3); }
        .nav-inactive { background: white; color: #64748b; border: 1px solid #e2e8f0; }
        .nav-inactive:hover { background: #f8fafc; border-color: #cbd5e1; }

        /* ALIGNMENT BLOCK STYLE */
        .aln-container { font-family: 'Roboto Mono', monospace; font-size: 13px; line-height: 1.5; white-space: pre; overflow-x: auto; }
        .aln-block { margin-bottom: 24px; background: white; padding: 10px; border-radius: 8px; border: 1px solid #e2e8f0; }
        .aln-row { display: flex; }
        .aln-label { width: 100px; flex-shrink: 0; color: #64748b; font-weight: bold; text-align: right; padding-right: 15px; user-select: none; }
        .aln-seq { color: #1e293b; letter-spacing: 1px; }
        
        .pos-line { color: #3b82f6; font-weight: bold; margin-bottom: 2px; } /* The Ruler */
        .seq-ref { font-weight: bold; color: #0f172a; border-bottom: 1px solid #f1f5f9; display: block; padding-bottom: 2px; margin-bottom: 2px; }
        .seq-mut { color: #475569; }

        .c-match { color: #cbd5e1; } /* Dot */
        .c-mut { color: #dc2626; background-color: #fee2e2; font-weight: bold; border-radius: 2px; }
        .c-gap { color: #94a3b8; }

        /* MASKING LIST */
        .mask-item { background: white; border-bottom: 1px solid #f1f5f9; padding: 8px; font-family: 'Roboto Mono', monospace; font-size: 11px; display: flex; gap: 8px; align-items: center; }
        .mask-item:last-child { border-bottom: none; }
        .mask-item:hover { background-color: #f8fafc; }
        .mask-idx { color: #94a3b8; width: 25px; text-align: right; font-weight: bold; user-select: none; }

        /* GRID */
        .mask-box { width: 30px; height: 35px; border: 1px solid #e2e8f0; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; background: white; border-radius: 4px; }
        .mask-box.active { background-color: #ef4444; border-color: #dc2626; color: white; }
        
        /* CODON */
        .codon-card { border: 1px solid #e2e8f0; background: white; border-radius: 6px; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 4px; }
        .codon-rare { background: #fff1f2; border-color: #fda4af; }
        .codon-rare .seq { color: #be123c; font-weight: bold; }
    </style>
</head>
<body class="p-4 md:p-8 max-w-7xl mx-auto min-h-screen">

    <header class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
        <div>
            <h1 class="text-2xl font-bold text-slate-800 flex items-center gap-2">
                üß¨ Workbench <span class="text-xs bg-slate-700 text-white px-2 py-1 rounded">V25.0</span>
            </h1>
            <p class="text-slate-500 text-xs">Block Align | Visual Mask List | Yellow Label</p>
        </div>
        <nav class="flex gap-2">
            <button onclick="show('align')" id="btn-align" class="nav-btn nav-active">Alignment</button>
            <button onclick="show('mask')" id="btn-mask" class="nav-btn nav-inactive">Masking</button>
            <button onclick="show('codon')" id="btn-codon" class="nav-btn nav-inactive">Rare Codon</button>
        </nav>
    </header>

    <main id="view-align" class="tool-view">
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
            <h2 class="text-lg font-bold text-slate-800 mb-4">‚õìÔ∏è Alignment (Block View)</h2>
            <textarea id="alnInput" class="w-full h-32 p-3 border border-slate-300 rounded font-mono text-xs uppercase mb-4" 
placeholder=">Reference
MKTIIALSYIFCLVFADYK...
>Mutant_1
MKTII.......K......"></textarea>
            <button onclick="runAlign()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded text-sm font-bold shadow-sm">Analyze Alignment</button>
            
            <div id="alnOutput" class="mt-8">
                </div>
        </div>
    </main>

    <main id="view-mask" class="tool-view hidden">
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
            <h2 class="text-lg font-bold text-slate-800 mb-4">üé≠ Masking Generator</h2>
            
            <div class="mb-6">
                <input id="maskSeq" type="text" class="w-full p-2 border border-slate-300 rounded font-mono uppercase text-sm mb-2" placeholder="Protein Sequence..." oninput="renderGrid()">
                <div id="gridArea" class="flex flex-wrap gap-1 p-2 bg-slate-50 border rounded max-h-40 overflow-y-auto"></div>
                <div class="flex gap-2 mt-2">
                    <button onclick="addFromGrid()" class="bg-slate-600 text-white text-xs px-3 py-1 rounded font-bold">Add Selected</button>
                    <button onclick="resetGrid()" class="text-red-500 text-xs hover:underline ml-auto">Reset Grid</button>
                </div>
            </div>

            <div class="bg-blue-50 p-3 rounded border border-blue-100 mb-6 flex gap-2 items-center">
                <span class="text-xs font-bold text-blue-800">Auto Scan:</span>
                <input id="winSize" value="3" class="w-12 text-center text-xs p-1 border rounded" placeholder="Win">
                <input id="stepSize" value="1" class="w-12 text-center text-xs p-1 border rounded" placeholder="Step">
                <button onclick="runAutoScan()" class="bg-blue-600 text-white text-xs px-3 py-1 rounded font-bold">Generate All</button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 h-80">
                <div class="flex flex-col">
                    <div class="flex justify-between mb-1">
                        <label class="text-xs font-bold text-slate-500">Raw Text (For Copying)</label>
                        <button onclick="copyRaw()" id="btnCopy" class="text-xs text-green-600 font-bold hover:underline">Copy All</button>
                    </div>
                    <textarea id="maskRaw" class="flex-1 p-2 border border-slate-200 rounded font-mono text-xs resize-none" readonly></textarea>
                </div>
                
                <div class="flex flex-col">
                    <label class="text-xs font-bold text-slate-500 mb-1">Preview List (<span id="countLib">0</span>)</label>
                    <div id="maskVisual" class="flex-1 border border-slate-200 rounded bg-slate-50 overflow-y-auto">
                        <div class="text-center text-slate-400 text-xs mt-10">List is empty</div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <main id="view-codon" class="tool-view hidden">
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold text-slate-800">ü¶† Rare Codon Map</h2>
                <span class="bg-yellow-400 text-yellow-900 px-3 py-1 rounded-full text-xs font-bold shadow-sm border border-yellow-500">
                    Ref: E. coli K12 (Kazusa)
                </span>
            </div>
            <textarea id="codonInput" class="w-full p-3 border border-slate-200 rounded font-mono text-sm uppercase h-24 mb-4 focus:outline-none focus:ring-2 focus:ring-yellow-400" placeholder="PASTE DNA SEQUENCE..." oninput="analyzeCodons()"></textarea>
            <div class="p-4 bg-slate-50 border border-slate-200 rounded-xl">
                <div id="codonGrid" class="grid grid-cols-8 md:grid-cols-12 gap-2"></div>
            </div>
        </div>
    </main>

    <script>
        // --- NAVIGATION ---
        function show(id) {
            document.querySelectorAll('.tool-view').forEach(e => e.classList.add('hidden'));
            document.getElementById('view-'+id).classList.remove('hidden');
            ['align','mask','codon'].forEach(k => {
                document.getElementById('btn-'+k).className = (k===id) ? 'nav-btn nav-active' : 'nav-btn nav-inactive';
            });
        }

        // ===========================================
        // 1. ALIGNMENT (BLOCK STYLE + REF RULER)
        // ===========================================
        function runAlign() {
            const raw = document.getElementById('alnInput').value;
            const lines = raw.split('\n');
            let seqs = [], curr = {n:'', s:''};
            
            lines.forEach(l => {
                l = l.trim();
                if(l.startsWith('>')) { if(curr.n) seqs.push(curr); curr={n:l.substring(1),s:''}; }
                else curr.s += l.replace(/[^A-Za-z\-\.]/g,'').toUpperCase();
            });
            if(curr.n) seqs.push(curr);
            if(seqs.length === 0) return;

            const ref = seqs[0];
            const width = 50; // Block width
            let html = `<div class="aln-container">`;

            for(let i=0; i < ref.s.length; i += width) {
                html += `<div class="aln-block">`;
                
                // 1. Ruler Line (Only for Reference)
                let rulerStr = "";
                // Create a string of spaces, then replace specific indices with numbers
                let rulerArr = Array(width).fill(' ');
                for(let k=0; k<width; k++) {
                    let realPos = i + k + 1;
                    if(realPos > ref.s.length) break;
                    
                    if(realPos % 10 === 0) {
                        let numStr = realPos.toString();
                        // Place number ending at k
                        for(let d=0; d<numStr.length; d++) {
                            let idx = k - numStr.length + 1 + d;
                            if(idx >= 0 && idx < width) rulerArr[idx] = numStr[d];
                        }
                    } else if (realPos % 5 === 0) {
                        rulerArr[k] = '|';
                    } else {
                        rulerArr[k] = '.';
                    }
                }
                html += `<div class="aln-row">
                            <div class="aln-label">Pos</div>
                            <div class="aln-seq pos-line">${rulerArr.join('')}</div>
                         </div>`;

                // 2. Reference Sequence
                let chunkRef = ref.s.substr(i, width);
                html += `<div class="aln-row">
                            <div class="aln-label" title="${ref.n}">${ref.n}</div>
                            <div class="aln-seq seq-ref">${chunkRef}</div>
                         </div>`;

                // 3. Mutants
                for(let m=1; m<seqs.length; m++) {
                    let sObj = seqs[m];
                    let chunkMut = sObj.s.substr(i, width);
                    let vis = "";
                    
                    for(let k=0; k<chunkMut.length; k++) {
                        let mc = chunkMut[k];
                        let rc = chunkRef[k] || '';
                        
                        if(mc === rc && mc !== '-') vis += `<span class="c-match">.</span>`;
                        else if (mc === '-') vis += `<span class="c-gap">-</span>`;
                        else vis += `<span class="c-mut">${mc}</span>`;
                    }

                    html += `<div class="aln-row">
                                <div class="aln-label" title="${sObj.n}">${sObj.n}</div>
                                <div class="aln-seq seq-mut">${vis}</div>
                             </div>`;
                }

                html += `</div>`; // End Block
            }
            html += `</div>`;
            document.getElementById('alnOutput').innerHTML = html;
        }

        // ===========================================
        // 2. MASKING (VISUAL LIST + GRID)
        // ===========================================
        let libraryList = [];

        function renderGrid() {
            const seq = document.getElementById('maskSeq').value.trim().toUpperCase();
            const area = document.getElementById('gridArea');
            if(!seq) { area.innerHTML = ""; return; }
            
            let h = "";
            for(let i=0; i<seq.length; i++) {
                h += `<div class="mask-box" id="mb-${i}" onclick="toggleBox(${i})">
                    <span class="text-[10px] font-bold">${seq[i]}</span>
                    <span class="text-[8px] text-slate-400">${i+1}</span>
                </div>`;
            }
            area.innerHTML = h;
        }

        function toggleBox(i) {
            document.getElementById(`mb-${i}`).classList.toggle('active');
        }
        function resetGrid() {
            document.querySelectorAll('.mask-box').forEach(b => b.classList.remove('active'));
        }

        function addFromGrid() {
            const seq = document.getElementById('maskSeq').value.trim().toUpperCase();
            if(!seq) return;
            let res = "";
            let hasMask = false;
            for(let i=0; i<seq.length; i++) {
                const b = document.getElementById(`mb-${i}`);
                if(b && b.classList.contains('active')) { res += "_"; hasMask = true; }
                else res += seq[i];
            }
            if(hasMask) {
                if(!libraryList.includes(res)) libraryList.push(res);
                updateMaskOutput();
            }
        }

        function runAutoScan() {
            const seq = document.getElementById('maskSeq').value.trim().toUpperCase();
            if(!seq) return;
            const win = parseInt(document.getElementById('winSize').value)||3;
            const step = parseInt(document.getElementById('stepSize').value)||1;
            
            libraryList = []; // Clear old on new auto run? Usually yes.
            
            for(let i=0; i<=seq.length-win; i+=step) {
                libraryList.push(seq.substring(0,i) + "_".repeat(win) + seq.substring(i+win));
            }
            updateMaskOutput();
        }

        function updateMaskOutput() {
            // Update Textarea
            document.getElementById('maskRaw').value = libraryList.join('\n');
            document.getElementById('countLib').innerText = libraryList.length;

            // Update Visual List
            let h = "";
            libraryList.forEach((s, i) => {
                h += `<div class="mask-item">
                    <div class="mask-idx">${i+1}.</div>
                    <div class="font-bold text-slate-700">${s
