<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Molecular Toolkit</title>
<style>
body {
  font-family: Arial, sans-serif;
  max-width: 900px;
  margin: 40px auto;
  color: #222;
}
textarea, input {
  width: 100%;
  padding: 8px;
  margin: 6px 0;
  border: 1px solid #ccc;
  font-size: 14px;
}
button {
  padding: 6px 12px;
  border: 1px solid #333;
  background: white;
  cursor: pointer;
}
section {
  margin-bottom: 60px;
}
.residue {
  display: inline-block;
  padding: 2px 4px;
  cursor: pointer;
}
.marked {
  background: black;
  color: white;
}
.rare {
  color: red;
}
.small {
  font-size: 12px;
  color: gray;
}
</style>
</head>
<body>

<h1>Molecular Toolkit</h1>

<section>
<h2>Primer Analyzer</h2>

<div id="primerContainer"></div>
<button onclick="addPrimer()">+ Add Primer</button>

</section>

<section>
<h2>Protein Marker (ESM)</h2>

<textarea id="proteinInput" placeholder="Paste protein sequence"></textarea>
<div id="proteinDisplay"></div>
<button onclick="copyMarked()">Copy Marked Sequence</button>

</section>

<section>
<h2>Rare Codon (E. coli)</h2>

<textarea id="dnaInput" placeholder="Paste DNA sequence"></textarea>
<div id="rareOutput"></div>

</section>

<script>

let primers = [{seq:"", start:1, end:10}];
let markedPositions = [];

function gcPercent(seq){
  let gc = (seq.match(/[GC]/gi)||[]).length;
  return seq.length ? ((gc/seq.length)*100).toFixed(1) : 0;
}

function tmBasic(seq){
  let A=(seq.match(/A/gi)||[]).length;
  let T=(seq.match(/T/gi)||[]).length;
  let G=(seq.match(/G/gi)||[]).length;
  let C=(seq.match(/C/gi)||[]).length;
  if(!seq.length) return 0;
  if(seq.length<25) return 2*(A+T)+4*(G+C);
  return (64.9 + (41*(G+C-16.4))/seq.length).toFixed(1);
}

function hairpinCheck(seq){
  for(let i=0;i<seq.length-4;i++){
    let f=seq.slice(i,i+4);
    let rc=f.split("").reverse().map(b=>({A:"T",T:"A",G:"C",C:"G"}[b]||b)).join("");
    if(seq.includes(rc)) return "possible";
  }
  return "low";
}

function renderPrimers(){
  let container=document.getElementById("primerContainer");
  container.innerHTML="";
  primers.forEach((p,i)=>{
    let anneal=p.seq.slice(p.start-1,p.end);
    container.innerHTML+=`
      <div style="border:1px solid #ccc;padding:10px;margin-bottom:10px;">
      <textarea oninput="updatePrimer(${i},'seq',this.value)" placeholder="Primer sequence">${p.seq}</textarea>
      <input type="number" value="${p.start}" onchange="updatePrimer(${i},'start',this.value)">
      <input type="number" value="${p.end}" onchange="updatePrimer(${i},'end',this.value)">
      <div class="small">
      Full GC: ${gcPercent(p.seq)}% |
      Full Tm: ${tmBasic(p.seq)}°C |
      Hairpin: ${hairpinCheck(p.seq)} |
      Anneal Tm: ${tmBasic(anneal)}°C
      </div>
      </div>
    `;
  });
}

function updatePrimer(i,key,value){
  primers[i][key]=key==="seq"?value:value*1;
  renderPrimers();
}

function addPrimer(){
  primers.push({seq:"",start:1,end:10});
  renderPrimers();
}

document.getElementById("proteinInput").addEventListener("input",function(){
  let seq=this.value.trim();
  let display=document.getElementById("proteinDisplay");
  display.innerHTML="";
  seq.split("").forEach((aa,i)=>{
    let span=document.createElement("span");
    span.textContent=aa;
    span.className="residue";
    span.onclick=function(){
      if(markedPositions.includes(i)){
        markedPositions=markedPositions.filter(x=>x!==i);
        span.classList.remove("marked");
      }else{
        markedPositions.push(i);
        span.classList.add("marked");
      }
    };
    display.appendChild(span);
  });
});

function copyMarked(){
  let seq=document.getElementById("proteinInput").value.trim().split("");
  let result=seq.map((aa,i)=>markedPositions.includes(i)?"_":aa).join("");
  navigator.clipboard.writeText(result);
}

const rareTable={
  AGG:2, AGA:4, CGA:4, CGG:4, ATA:7, CTA:4
};

document.getElementById("dnaInput").addEventListener("input",function(){
  let seq=this.value.toUpperCase().replace(/[^ATGC]/g,"");
  let codons=seq.match(/.{1,3}/g)||[];
  let output=document.getElementById("rareOutput");
  output.innerHTML="";
  codons.forEach(c=>{
    let span=document.createElement("span");
    span.textContent=c+" ";
    if(rareTable[c] && rareTable[c]<10) span.className="rare";
    output.appendChild(span);
  });
});

renderPrimers();

</script>

</body>
</html>
