<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Molecular Workbench V20 (Complete)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; color: #334155; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        
        /* Tabs */
        .tab-btn { transition: all 0.2s; }
        .tab-active { background-color: #4f46e5; color: white; box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.2); }
        .tab-inactive { background-color: white; color: #64748b; border: 1px solid #cbd5e1; }
        .tab-inactive:hover { background-color: #f8fafc; }

        /* ALIGNMENT */
        .aln-block { margin-bottom: 20px; border-bottom: 1px dashed #e2e8f0; padding-bottom: 10px; }
        .aln-row { display: flex; align-items: center; font-size: 11px; line-height: 1.4; }
        .aln-name { width: 100px; flex-shrink: 0; text-align: right; padding-right: 10px; font-weight: bold; color: #475569; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
        .aln-idx { width: 35px; flex-shrink: 0; text-align: center; color: #94a3b8; user-select: none; }
        .aln-seq-box { width: 800px; font-family: 'JetBrains Mono', monospace; letter-spacing: 0.5px; } /* 100 chars approx 8px width each */
        
        .c-dot { color: #cbd5e1; }
        .c-mut { color: #dc2626; font-weight: bold; background-color: #fee2e2; }
        .c-gap { color: #94a3b8; }
        .c-ref { color: #1e293b; font-weight: bold; }

        /* MASKING */
        .residue-box { width: 26px; height: 36px; margin: 2px; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; background: white; border: 1px solid #e2e8f0; border-radius: 4px; }
        .residue-box:hover { border-color: #6366f1; transform: translateY(-1px); }
        .residue-char { font-weight: bold; font-size: 14px; }
        .residue-num { font-size: 8px; color: #94a3b8; }
        .residue-box.masked { background-color: #fee2e2; border-color: #fca5a5; }
        .residue-box.masked .residue-char { color: #dc2626; text-decoration: line-through; opacity: 0.5; }

        /* CODON */
        .codon-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(36px, 1fr)); gap: 4px; }
        .codon-box { height: 48px; background: white; border: 1px solid #e2e8f0; border-radius: 4px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .codon-box.is-rare { background-color: #fef2f2; border-color: #fca5a5; }
        .codon-box.is-rare .cb-seq { color: #dc2626; font-weight: bold; }
        .cb-aa { font-size: 10px; color: #64748b; font-weight: bold; line-height: 1; }
        .cb-seq { font-size: 11px; font-family: 'JetBrains Mono', monospace; color: #334155; }
        .cb-pos { font-size: 8px; color: #94a3b8; margin-top: 2px; }
    </style>
</head>
<body class="p-4 min-h-screen">

    <div class="max-w-[1200px] mx-auto">
        <header class="flex flex-col md:flex-row justify-between items-center gap-4 mb-6">
            <div>
                <h1 class="text-2xl font-bold text-slate-800 flex items-center gap-2">
                    üß¨ Molecular Workbench <span class="text-xs bg-indigo-600 text-white px-2 py-1 rounded">v20.0</span>
                </h1>
                <p class="text-slate-500 text-sm">Full Suite: Primer, Alignment (100w), Masking & Rare Codons</p>
            </div>
            <nav class="flex gap-2">
                <button onclick="switchTab('primer')" id="btn-primer" class="tab-btn tab-inactive px-4 py-2 rounded-lg text-sm font-bold">Primer</button>
                <button onclick="switchTab('align')" id="btn-align" class="tab-btn tab-active px-4 py-2 rounded-lg text-sm font-bold">Alignment</button>
                <button onclick="switchTab('mask')" id="btn-mask" class="tab-btn tab-inactive px-4 py-2 rounded-lg text-sm font-bold">Masking</button>
                <button onclick="switchTab('codon')" id="btn-codon" class="tab-btn tab-inactive px-4 py-2 rounded-lg text-sm font-bold">Codon</button>
            </nav>
        </header>

        <main id="content-primer" class="tool-content hidden">
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                <h2 class="text-xl font-bold text-slate-800 mb-4">üß™ Primer Analyzer</h2>
                <div class="flex gap-4 mb-4">
                    <input id="primerInput" type="text" class="flex-1 p-3 border border-slate-300 rounded font-mono uppercase text-sm" placeholder="ATGC..." oninput="analyzePrimer()">
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 bg-slate-50 p-4 rounded-lg border border-slate-200">
                    <div><div class="text-xs text-slate-500 font-bold">Length</div><div id="pLen" class="text-lg font-mono font-bold text-indigo-600">-</div></div>
                    <div><div class="text-xs text-slate-500 font-bold">GC Content</div><div id="pGC" class="text-lg font-mono font-bold text-indigo-600">-</div></div>
                    <div><div class="text-xs text-slate-500 font-bold">Tm (Basic)</div><div id="pTm" class="text-lg font-mono font-bold text-indigo-600">-</div></div>
                    <div><div class="text-xs text-slate-500 font-bold">Rev-Comp</div><div id="pRev" class="text-xs font-mono break-all text-slate-600 mt-1">-</div></div>
                </div>
            </div>
        </main>

        <main id="content-align" class="tool-content">
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                <h2 class="text-xl font-bold text-slate-800 mb-2">‚õìÔ∏è Multi-Align Pro (100 char/line)</h2>
                <textarea id="alnInput" class="w-full h-32 p-3 border border-slate-300 rounded font-mono text-xs uppercase focus:ring-2 focus:ring-indigo-500 mb-4" 
placeholder=">WT_Reference
MKTIIALSYIFCLVFADYKDDDDK...
>Mutant_1
MKTIIALSYIFCLVFADYK....."></textarea>
                <button onclick="runAlignment()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded text-sm shadow-sm">Run Alignment</button>

                <div id="alnOutput" class="hidden mt-6 border-t border-slate-200 pt-4">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-xs font-bold text-slate-500">Visualization (Dots = Match Ref)</span>
                        <button onclick="copyAln()" id="btnCopyAln" class="text-xs bg-slate-100 hover:bg-slate-200 px-3 py-1 rounded border">Copy Text</button>
                    </div>
                    <div class="overflow-x-auto bg-white border border-slate-200 rounded p-4 shadow-inner">
                        <div id="alnVisual" style="min-width: 1000px;"></div>
                    </div>
                </div>
            </div>
        </main>

        <main id="content-mask" class="tool-content hidden">
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                <h2 class="text-xl font-bold text-slate-800 mb-4">üé≠ Masking Generator</h2>
                <input id="protSeq" type="text" class="w-full p-2 border border-slate-300 rounded font-mono uppercase text-sm mb-4" placeholder="SEQUENCE...">
                
                <div class="grid grid-cols-1 md:grid-cols-4 gap-3 mb-6">
                    <div class="p-3 bg-indigo-50 rounded border border-indigo-100">
                        <div class="font-bold text-xs text-indigo-900 mb-2">Sliding Window</div>
                        <input id="slideSize" value="3" class="w-10 p-1 text-xs rounded border text-center"> Size
                        <button onclick="genMask('sliding')" class="mt-2 w-full bg-indigo-600 text-white text-xs py-1 rounded font-bold">Go</button>
                    </div>
                    <div class="p-3 bg-purple-50 rounded border border-purple-100">
                        <div class="font-bold text-xs text-purple-900 mb-2">Inverse</div>
                        <input id="invSize" value="5" class="w-10 p-1 text-xs rounded border text-center"> Keep
                        <button onclick="genMask('inverse')" class="mt-2 w-full bg-purple-600 text-white text-xs py-1 rounded font-bold">Go</button>
                    </div>
                    <div class="p-3 bg-slate-50 rounded border border-slate-200">
                        <div class="font-bold text-xs text-slate-700 mb-2">Target/Zip</div>
                        <input id="targetRes" placeholder="K,C" class="w-full p-1 text-xs rounded border uppercase mb-1">
                        <button onclick="genMask('target')" class="w-full bg-slate-600 text-white text-[10px] py-1 rounded">Mask</button>
                    </div>
                    <div class="p-3 bg-slate-50 rounded border border-slate-200">
                        <div class="font-bold text-xs text-slate-700 mb-2">Manual</div>
                        <button onclick="openClicker()" class="w-full h-full bg-slate-400 hover:bg-slate-500 text-white text-xs rounded font-bold">Open Grid</button>
                    </div>
                </div>

                <div id="maskResultArea" class="hidden">
                    <div class="flex justify-between mb-1">
                        <span class="text-xs font-bold text-slate-700">Generated (<span id="maskCount">0</span>)</span>
                        <button onclick="copyMaskResults()" id="btnCopyMask" class="text-xs bg-green-600 text-white px-3 py-1 rounded font-bold shadow-sm hover:bg-green-700">Copy All</button>
                    </div>
                    <textarea id="maskOutputText" class="w-full h-32 p-2 bg-slate-50 border border-slate-200 rounded font-mono text-xs text-slate-600 leading-tight" readonly></textarea>
                </div>
                <div id="clickerArea" class="mt-4"></div>
            </div>
        </main>

        <main id="content-codon" class="tool-content hidden">
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                <div class="flex justify-between items-start mb-2">
                    <h2 class="text-xl font-bold text-slate-800">ü¶† Rare Codon Map</h2>
                    <span class="text-[10px] bg-amber-50 text-amber-800 px-2 py-1 rounded border border-amber-100">Ref: Kazusa DB (E. coli K12)</span>
                </div>
                <textarea id="codonInput" class="w-full p-3 border border-slate-200 rounded font-mono text-xs uppercase h-24 mb-4" placeholder="PASTE DNA SEQUENCE..." oninput="analyzeCodons()"></textarea>
                <div class="p-4 bg-slate-50 border border-slate-200 rounded-lg min-h-[100px]">
                    <div id="codonVisual" class="codon-grid"></div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- GLOBAL & TABS ---
        function switchTab(t) {
            document.querySelectorAll('.tool-content').forEach(e => e.classList.add('hidden'));
            document.getElementById('content-'+t).classList.remove('hidden');
            ['primer','align','mask','codon'].forEach(x => {
                document.getElementById('btn-'+x).className = (x===t) 
                ? 'tab-btn tab-active px-4 py-2 rounded-lg text-sm font-bold' 
                : 'tab-btn tab-inactive px-4 py-2 rounded-lg text-sm font-bold';
            });
        }

        // ===========================================
        // 1. PRIMER LOGIC (Restored)
        // ===========================================
        function analyzePrimer() {
            const s = document.getElementById('primerInput').value.toUpperCase().replace(/[^ATGC]/g,'');
            if(!s) { 
                ['pLen','pGC','pTm','pRev'].forEach(i=>document.getElementById(i).innerText='-'); 
                return; 
            }
            const len = s.length;
            const gc = (s.match(/[GC]/g)||[]).length;
            const gcP = ((gc/len)*100).toFixed(1);
            
            // Basic Tm: 4*(G+C) + 2*(A+T) if len < 14, else 64.9 + 41*(G+C-16.4)/len
            let tm = 0;
            if(len < 14) tm = (gc * 4) + ((len-gc) * 2);
            else tm = 64.9 + 41 * (gc - 16.4) / len;

            // Rev Comp
            const rc = s.split('').reverse().map(c => ({'A':'T','T':'A','G':'C','C':'G'})[c]).join('');

            document.getElementById('pLen').innerText = len + " bp";
            document.getElementById('pGC').innerText = gcP + "%";
            document.getElementById('pTm').innerText = tm.toFixed(1) + " ¬∞C";
            document.getElementById('pRev').innerText = rc;
        }

        // ===========================================
        // 2. ALIGNMENT LOGIC (100w + Indexing)
        // ===========================================
        function runAlignment() {
            const raw = document.getElementById('alnInput').value;
            if(!raw.trim()) return;
            
            // Parse FASTA
            const lines = raw.split('\n');
            let seqs = [];
            let current = {name:'', seq:''};
            lines.forEach(l => {
                l = l.trim();
                if(l.startsWith('>')) {
                    if(current.name) seqs.push(current);
                    current = {name: l.substring(1), seq:''};
                } else {
                    current.seq += l.replace(/[^A-Za-z\-\.]/g,'').toUpperCase();
                }
            });
            if(current.name) seqs.push(current);
            if(seqs.length === 0) seqs = [{name:'Input', seq: raw.replace(/[^A-Z]/gi,'').toUpperCase()}]; // Fallback raw

            // Simple "Ref-Anchored" Alignment (Assumes pre-aligned or simplistic pairwise)
            // Note: True MSA happens server-side, here we visualize.
            // If lengths differ, we pad with gaps for visualization safety
            const maxLen = Math.max(...seqs.map(s => s.seq.length));
            seqs.forEach(s => {
                s.seq = s.seq.padEnd(maxLen, '-');
                s.currIdx = 1; // Start counter for each sequence
            });

            const refSeq = seqs[0].seq;
            const WIDTH = 100;
            let html = "";
            let textOutput = "";

            for(let i=0; i<maxLen; i+=WIDTH) {
                html += `<div class="aln-block">`;
                
                seqs.forEach((entry, idx) => {
                    const chunk = entry.seq.substr(i, WIDTH);
                    
                    // Calculate Indices for this chunk (ignoring gaps)
                    // The logic: Start index is current `currIdx`.
                    // Count non-gap chars in chunk.
                    // End index is Start + count - 1.
                    // Update `currIdx` for next block.
                    
                    const nonGapCount = (chunk.match(/[^-]/g) || []).length;
                    const startLabel = (nonGapCount > 0) ? entry.currIdx : ""; 
                    const endLabel = (nonGapCount > 0) ? (entry.currIdx + nonGapCount - 1) : "";
                    
                    // Update global counter for this seq
                    entry.currIdx += nonGapCount;

                    // Visualization (Dot View)
                    let viz = "";
                    for(let x=0; x<chunk.length; x++) {
                        const char = chunk[x];
                        const refChar = refSeq[i+x];
                        
                        if(idx === 0) { // Reference
                            viz += `<span class="c-ref">${char}</span>`;
                        } else { // Mutants
                            if(char === refChar && char !== '-') viz += `<span class="c-dot">.</span>`;
                            else if(char === '-') viz += `<span class="c-gap">-</span>`;
                            else viz += `<span class="c-mut">${char}</span>`;
                        }
                    }

                    html += `
                    <div class="aln-row">
                        <div class="aln-name" title="${entry.name}">${entry.name}</div>
                        <div class="aln-idx">${startLabel}</div>
                        <div class="aln-seq-box">${viz}</div>
                        <div class="aln-idx text-left pl-2">${endLabel}</div>
                    </div>`;
                    
                    // Plain text for copy (convert matching to dots manually)
                    let txtChunk = "";
                    for(let x=0; x<chunk.length; x++) {
                        if(idx !== 0 && chunk[x] === refSeq[i+x] && chunk[x] !== '-') txtChunk += ".";
                        else txtChunk += chunk[x];
                    }
                    textOutput += `${entry.name.padEnd(15)} ${String(startLabel).padStart(4)} ${txtChunk} ${endLabel}\n`;
                });

                html += `</div>`;
                textOutput += "\n";
            }

            document.getElementById('alnVisual').innerHTML = html;
            document.getElementById('alnOutput').classList.remove('hidden');
            window.alnText = textOutput;
        }

        function copyAln() {
            navigator.clipboard.writeText(window.alnText || "");
            let b = document.getElementById('btnCopyAln');
            b.innerText = "Copied!"; setTimeout(()=>b.innerText="Copy Text",1000);
        }

        // ===========================================
        // 3. MASKING LOGIC (Fixed Copy & Logic)
        // ===========================================
        function getProt() { return document.getElementById('protSeq').value.trim().toUpperCase(); }
        
        function genMask(mode) {
            const seq = getProt();
            if(!seq) return alert("Please enter a sequence");
            let results = [];
            
            if(mode === 'sliding') {
                const sz = parseInt(document.getElementById('slideSize').value);
                for(let i=0; i<=seq.length-sz; i++) {
                    results.push(seq.substring(0,i) + "_".repeat(sz) + seq.substring(i+sz));
                }
            } else if (mode === 'inverse') {
                const sz = parseInt(document.getElementById('invSize').value);
                for(let i=0; i<=seq.length-sz; i++) {
                    results.push("_".repeat(i) + seq.substring(i,i+sz) + "_".repeat(seq.length-(i+sz)));
                }
            } else if (mode === 'target') {
                const t = document.getElementById('targetRes').value.toUpperCase().split(',');
                let s = seq;
                t.forEach(char => { 
                    if(char.trim()) s = s.replaceAll(char.trim(), '_'); 
                });
                results.push(s);
            }

            document.getElementById('maskOutputText').value = results.join('\n');
            document.getElementById('maskCount').innerText = results.length;
            document.getElementById('maskResultArea').classList.remove('hidden');
        }

        function copyMaskResults() {
            const txt = document.getElementById('maskOutputText');
            txt.select();
            document.execCommand('copy'); // Fallback ensures compatibility
            navigator.clipboard.writeText(txt.value).then(() => {
                const btn = document.getElementById('btnCopyMask');
                btn.innerText = "‚úÖ Done";
                setTimeout(() => btn.innerText = "Copy All", 1000);
            });
        }

        function openClicker() {
            const seq = getProt();
            if(!seq) return;
            const area = document.getElementById('clickerArea');
            let h = `<div class="bg-slate-100 p-4 rounded border"><div class="flex flex-wrap gap-1 mb-2">`;
            seq.split('').forEach((c,i) => {
                h += `<div class="residue-box" onclick="this.classList.toggle('masked')">
                    <span class="residue-char">${c}</span>
                    <span class="residue-num">${i+1}</span>
                </div>`;
            });
            h += `</div><button onclick="copyFromGrid(this)" class="bg-indigo-600 text-white text-xs px-3 py-1 rounded">Generate & Copy Pattern</button></div>`;
            area.innerHTML = h;
        }

        function copyFromGrid(btn) {
            const boxes = btn.previousElementSibling.children;
            let str = "";
            for(let b of boxes) {
                str += b.classList.contains('masked') ? "_" : b.querySelector('.residue-char').innerText;
            }
            navigator.clipboard.writeText(str);
            btn.innerText = "Copied to Clipboard!";
            setTimeout(()=>btn.innerText="Generate & Copy Pattern", 1000);
        }

        // ===========================================
        // 4. RARE CODON LOGIC
        // ===========================================
        function analyzeCodons() {
            const dna = document.getElementById('codonInput').value.toUpperCase().replace(/[^ATGC]/g,'');
            const map={'TTT':'F','TTC':'F','TTA':'L','TTG':'L','CTT':'L','CTC':'L','CTA':'L','CTG':'L','ATT':'I','ATC':'I','ATA':'I','ATG':'M','GTT':'V','GTC':'V','GTA':'V','GTG':'V','TCT':'S','TCC':'S','TCA':'S','TCG':'S','CCT':'P','CCC':'P','CCA':'P','CCG':'P','ACT':'T','ACC':'T','ACA':'T','ACG':'T','GCT':'A','GCC':'A','GCA':'A','GCG':'A','TAT':'Y','TAC':'Y','TAA':'*','TAG':'*','CAT':'H','CAC':'H','CAA':'Q','CAG':'Q','AAT':'N','AAC':'N','AAA':'K','AAG':'K','GAT':'D','GAC':'D','GAA':'E','GAG':'E','TGT':'C','TGC':'C','TGA':'*','TGG':'W','CGT':'R','CGC':'R','CGA':'R','CGG':'R','AGT':'S','AGC':'S','AGA':'R','AGG':'R','GGT':'G','GGC':'G','GGA':'G','GGG':'G'};
            // Kazusa E. coli K12 Frequencies (per thousand roughly converted to ratio)
            const rareList = ['CTA','ATA','CCC','TGT','TGC','AGA','AGG','GGA','GGG','CGA','CGG','TCA']; // Simplified 'Rare' list (<10% usage usually)
            
            let html = "";
            for(let i=0; i<dna.length; i+=3) {
                const c = dna.substr(i,3);
                if(c.length<3) break;
                const aa = map[c]||'?';
                // Check if rare in E.coli K12 context (Simple check list for UI speed)
                // Real usage: CTA(4%), ATA(5%), CCC(5%), TGT/C(5%), Arg(AGA/AGG/CGA/CGG very rare)
                const isRare = (['CTA','ATA','CCC','TCA','CGG','CGA','AGA','AGG','GGA','GGG'].includes(c));
                
                html += `<div class="codon-box ${isRare?'is-rare':''}">
                    <div class="cb-aa">${aa}</div>
                    <div class="cb-seq">${c}</div>
                    <div class="cb-pos">${i+1}</div>
                </div>`;
            }
            document.getElementById('codonVisual').innerHTML = html;
        }
    </script>
</body>
</html>
